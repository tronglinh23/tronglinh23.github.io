---
title: GRAND PRIX HEAVEN
description: ''
tags:
  - writeup
  - xss
  - csp
  - file-upload
category: web
draft: false
date: 2023-07-04
ctf_event: Googlectf2024
---

import Callout from '@/components/mdx/Callout.astro';

Status: Done

## Summary

<Callout type="note" title="Note">
ğŸ’¡ Bypass template routing to reach `mediaparser`, then abuse EXIF XSS.

</Callout>

## Description

## Analyst

- BÃ i nÃ y cÃ³ lá»— há»•ng XSS á»Ÿ file `mediaparser`. Tuy nhiÃªn file nÃ y khÃ´ng Ä‘Æ°á»£c gá»i trong cÃ¡c template nÃªn ta cáº§n tÃ¬m cÃ¡ch Ä‘á»ƒ gá»i Ä‘Æ°á»£c template nÃ y.

```js
app.get("/fave/:GrandPrixHeaven", async (req, res) => {
  const grandPrix = await Configuration.findOne({
    where: { public_id: req.params.GrandPrixHeaven },
  });
  if (!grandPrix) return res.status(400).json({ error: "ERROR: ID not found" });
  let defaultData = {
    0: "csp",
    1: "retrieve",
    2: "apiparser",
    3: "head_end",
    4: "faves",
    5: "footer",
  };
```

- á» Ä‘Ã¢y ta khÃ´ng gá»i Ä‘Æ°á»£c `mediaparser` nhÆ°ng ta cÃ³ giÃ¡ trá»‹ `custom` cÃ³ thá»ƒ thay Ä‘á»•i Ä‘oáº¡n nÃ y. Äoáº¡n check giÃ¡ trá»‹ `custom` nhÆ° sau:

![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled.png)

- á» Ä‘Ã¢y ta cÃ³ thá»ƒ bypass Ä‘Æ°á»£c `parseInt()` khi truyá»n vÃ o 1 string báº¯t Ä‘áº§u báº±ng sá»‘. ThÃªm ná»¯a khi `needle` nháº­n vÃ o `needleBody` thÃ¬ cÃ³ set multipart vÃ  boundary mÃ  boundary ta Ä‘Ã£ biáº¿t.

  ![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled-1.png)
- Tá»« Ä‘Ã³ ta nghÄ© Ä‘áº¿n Ã½ tÆ°á»Ÿng chÃ¨n `mediaparser` vÃ o giÃ¡ trá»‹ `k` nhÆ° sau:

```python
1_--GP_HEAVENmediaparser--GP_HEAVEN
```

- Tá»« Ä‘Ã³ ta cÃ³ thá»ƒ gá»i Ä‘Æ°á»£c `mediaparser`.
- ThÃªm 1 bÆ°á»›c ná»¯a, á»Ÿ file `mediaparser` cÃ³ gá»i Ä‘áº¿n class `Requester` (hÃ m nÃ y tá»« file `retriev.js`).

![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled-2.png)

![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled-3.png)

- Má»¥c tiÃªu cá»§a ta lÃ  cáº§n `makeRequest` tráº£ vá» response lÃ  file JPEG, tuy nhiÃªn `this.url` Ä‘Æ°á»£c set máº·c Ä‘á»‹nh `/api/get-car` nÃªn tráº£ vá» JSON.
- Ã tÆ°á»Ÿng: lÃ m sao Ä‘á»ƒ URL fetch Ä‘Æ°á»£c Ä‘áº¿n `/media/img_id` thÃ¬ sáº½ tráº£ vá» áº£nh. á» Ä‘oáº¡n clean URL, regex dÃ¹ng `[A-z]` (khÃ´ng pháº£i `[A-Za-z]`) nÃªn cÃ³ thá»ƒ bypass vÃ¬ cÃ³ cÃ¡c kÃ½ tá»± á»Ÿ giá»¯a váº«n dÃ¹ng Ä‘Æ°á»£c.

![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled-4.png)

- Ta cÃ³ thá»ƒ sá»­ dá»¥ng `\`, vÃ¬ backslash khi Ä‘Æ°á»£c set trong URL sáº½ tá»± chuyá»ƒn thÃ nh forward slash vÃ  cÃ³ thá»ƒ Ä‘iá»u hÆ°á»›ng sang media.
- Tá»« Ä‘Ã³ ta thÃ nh cÃ´ng trigger:

```python
https://grandprixheaven-web.2024.ctfcompetition.com/fave/3Pg8TkzJ6ifVyONPKTmNI?F1=\media\ttTE6KozICvAd5-jghfzN
```

- Táº¡o 1 file áº£nh báº±ng exiftool vá»›i payload XSS vÃ  upload lÃªn, sau Ä‘Ã³ gá»­i URL cho bot lÃ  láº¥y Ä‘Æ°á»£c flag.

![Untitled](/uploads/grand-prix-heaven/grand-prix-heaven/untitled-5.png)

## Exploit

## Result
