---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import LinkCard from '@/components/LinkCard.astro';
import { slugifyTag } from '@/lib/utils';
import { basePath } from '@/lib/base';
import { getBlogPosts, getLinkPosts, sortByDateAndMtime } from '@/lib/collections';

export async function getStaticPaths() {
  const all = [...(await getBlogPosts()), ...(await getLinkPosts())];
  const tags = new Set();
  for (const p of all) {
    for (const t of p.data.tags ?? []) tags.add(slugifyTag(t));
  }
  return [...tags].map((t) => ({ params: { tag: t } }));
}

const { tag } = Astro.params;
const all = [...(await getBlogPosts()), ...(await getLinkPosts())];

const matches = all.filter((p) => (p.data.tags ?? []).some((t) => slugifyTag(t) === tag))
  .sort(sortByDateAndMtime);

const human = matches.length ? (matches[0].data.tags ?? []).find((t) => slugifyTag(t) === tag) : tag;
---

<BaseLayout title={`Tag: ${human}`} description={`Posts tagged ${human}`}>
  <div class="mb-6">
    <h1 class="text-3xl font-semibold text-white/95">Tag: #{human}</h1>
    <p class="mt-2 text-white/70">{matches.length} posts</p>
  </div>

  <div class="grid gap-4">
    {matches.map((p) => {
      if (p.collection === 'links') return <LinkCard entry={p} />;

      const href = `${basePath}/blog/${p.slug}`;
      return <PostCard entry={p} href={href} />;
    })}
  </div>
</BaseLayout>
