---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import { getCollection } from 'astro:content';
import { slugifyTag } from '@/lib/utils';
import { basePath } from '@/lib/base';
import { formatDate, getEntryMtime } from '@/lib/utils';

export async function getStaticPaths() {
  const collections = ['blog', 'links'] as const;
  const all = (await Promise.all(collections.map((c) => getCollection(c)))).flat().filter((p) => !p.data.draft);
  const tags = new Set();
  for (const p of all) {
    for (const t of p.data.tags ?? []) tags.add(slugifyTag(t));
  }
  return [...tags].map((t) => ({ params: { tag: t } }));
}

const { tag } = Astro.params;
const collections = ['blog', 'links'] as const;
const all = (await Promise.all(collections.map((c) => getCollection(c)))).flat().filter((p) => !p.data.draft);

const matches = all.filter((p) => (p.data.tags ?? []).some((t) => slugifyTag(t) === tag))
  .sort((a, b) => getEntryMtime(b) - getEntryMtime(a));

const human = matches.length ? (matches[0].data.tags ?? []).find((t) => slugifyTag(t) === tag) : tag;
---

<BaseLayout title={`Tag: ${human}`} description={`Posts tagged ${human}`}>
  <div class="mb-6">
    <h1 class="text-3xl font-semibold text-white/95">Tag: #{human}</h1>
    <p class="mt-2 text-white/70">{matches.length} posts</p>
  </div>

  <div class="grid gap-4">
    {matches.map((p) => {
      if (p.collection === 'links') {
        return (
          <a
            href={p.data.source_url}
            target="_blank"
            rel="noreferrer"
            class="block rounded-3xl border border-white/10 bg-white/5 p-5 shadow-glass transition hover:border-white/20 hover:bg-white/10"
          >
            <div class="text-sm text-white/55">{formatDate(p.data.date)} · {p.data.category}</div>
            <h3 class="mt-2 text-lg font-semibold text-white/90">{p.data.title}</h3>
            <p class="mt-2 text-sm text-white/70">{p.data.description}</p>
            <div class="mt-4 text-sm text-white/70">Open ↗</div>
          </a>
        );
      }

      const href = `${basePath}/blog/${p.slug}`;
      return <PostCard entry={p} href={href} />;
    })}
  </div>
</BaseLayout>
