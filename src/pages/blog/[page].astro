---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SearchAndFilters from '@/components/SearchAndFilters.astro';
import PostCard from '@/components/PostCard.astro';
import { basePath } from '@/lib/base';
import { buildSearchItems, getBlogPosts } from '@/lib/collections';

export async function getStaticPaths({ paginate }) {
  const pageSize = 10;
  const posts = await getBlogPosts();

  return paginate(posts, { pageSize });
}

const { page } = Astro.props;
const pagePosts = page.data;
const totalPages = page.lastPage;
const currentPage = page.currentPage;
const pageHref = (n) => (n === 1 ? `${basePath}/blog` : `${basePath}/blog/${n}`);

const items = buildSearchItems(await getBlogPosts(), basePath);
---

<BaseLayout title={`Blog · Page ${currentPage}`} description="CTF writeups, research notes, and longer-form posts.">
  <div class="mb-6">
    <h1 class="text-3xl font-semibold text-white/95">Blog</h1>
    <p class="mt-2 text-white/70">CTF writeups, research notes, and deep dives.</p>
  </div>

  <SearchAndFilters items={items} />

  <div id="results" class="mt-6 grid gap-4">
    {pagePosts.map((p) => <PostCard entry={p} href={`${basePath}/blog/${p.slug}`} />)}
  </div>

  {
    totalPages > 1 && (
      <nav class="mt-8 flex flex-wrap items-center justify-between gap-3 text-sm text-white/70">
        <span>Page {currentPage} of {totalPages}</span>
        <div class="flex flex-wrap gap-2">
          {currentPage > 1 && (
            <a
              class="rounded-2xl border border-white/10 bg-black/20 px-3 py-2 text-white/75 hover:bg-white/10 hover:text-white"
              href={pageHref(currentPage - 1)}
            >
              ← Prev
            </a>
          )}
          {currentPage < totalPages && (
            <a
              class="rounded-2xl border border-white/10 bg-black/20 px-3 py-2 text-white/75 hover:bg-white/10 hover:text-white"
              href={pageHref(currentPage + 1)}
            >
              Next →
            </a>
          )}
        </div>
      </nav>
    )
  }
</BaseLayout>
